<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI RSS Dashboard</title>
    <!-- Tailwind CSS (Play CDN for quick testing) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #f97316;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-50 min-h-screen text-slate-800 font-sans">

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-slate-900 flex items-center gap-2">
                    <span class="text-orange-500">RSS</span> AI Reader
                </h1>
                <p class="text-slate-500 text-sm">最新情報をAIが要約</p>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="toggleConfig()" class="p-2 bg-white border border-slate-200 rounded-xl shadow-sm hover:bg-slate-50 transition-all text-slate-500" title="API設定">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
                <button onclick="refreshAll()" class="px-6 py-2 bg-orange-500 rounded-xl shadow-lg hover:bg-orange-600 transition-all font-bold text-white">更新</button>
            </div>
        </header>

        <!-- API設定エリア -->
        <div id="configArea" class="hidden mb-8 p-6 bg-slate-900 text-white rounded-3xl shadow-xl">
            <h3 class="text-lg font-bold mb-2">Gemini API設定</h3>
            <p class="text-slate-400 text-sm mb-4">APIキーを保存すると要約機能が有効になります。</p>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="password" id="userApiKey" placeholder="AI Studio API Key" 
                    class="flex-1 px-4 py-2 rounded-xl bg-slate-800 border border-slate-700 text-white focus:outline-none focus:ring-2 focus:ring-orange-500">
                <button onclick="saveApiKey()" class="px-8 py-2 bg-orange-500 hover:bg-orange-600 rounded-xl font-bold transition-all">保存</button>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            <!-- サイドバー -->
            <div class="lg:col-span-1 space-y-4">
                <div class="bg-white p-6 rounded-2xl border border-slate-200">
                    <label class="block text-xs font-bold text-slate-400 mb-2 uppercase">フィードを追加</label>
                    <input type="url" id="rssUrl" placeholder="https://..." class="w-full px-4 py-2 mb-2 rounded-xl border border-slate-200 text-sm focus:ring-2 focus:ring-orange-200 outline-none">
                    <button onclick="addFeed()" class="w-full bg-slate-900 text-white py-2 rounded-xl font-bold text-sm hover:bg-slate-800">追加</button>
                </div>
                <div id="subscriptionList" class="space-y-2"></div>
            </div>

            <!-- メイン記事エリア -->
            <div class="lg:col-span-3">
                <div id="articles" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-full py-20 text-center text-slate-400">読み込み中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 要約モーダル -->
    <div id="aiModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm hidden flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-3xl max-w-lg w-full p-8 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold flex items-center gap-2">✨ AI要約</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-600 font-bold text-2xl">&times;</button>
            </div>
            <div id="aiResult" class="text-slate-600 leading-relaxed min-h-[100px] text-sm"></div>
            <button onclick="closeModal()" class="w-full mt-6 bg-slate-100 py-3 rounded-2xl font-bold text-slate-600 hover:bg-slate-200">閉じる</button>
        </div>
    </div>

    <script>
        const modelName = "gemini-3-flash-preview"; 
        let feeds = JSON.parse(localStorage.getItem('rss_feeds')) || [
            "https://news.google.com/rss?hl=ja&gl=JP&ceid=JP:ja"
        ];

        function toggleConfig() {
            const area = document.getElementById('configArea');
            area.classList.toggle('hidden');
            document.getElementById('userApiKey').value = localStorage.getItem('user_gemini_api_key') || "";
        }

        function saveApiKey() {
            const val = document.getElementById('userApiKey').value.trim();
            localStorage.setItem('user_gemini_api_key', val);
            alert("APIキーを保存しました。");
            document.getElementById('configArea').classList.add('hidden');
        }

        // 重要：HTMLの引数経由ではなく、DOMからデータを取得する方式に変更
        async function handleSummarize(btn) {
            const title = btn.getAttribute('data-title');
            const desc = btn.getAttribute('data-desc');
            
            const modal = document.getElementById('aiModal');
            const resultArea = document.getElementById('aiResult');
            const activeKey = localStorage.getItem('user_gemini_api_key');
            
            modal.classList.remove('hidden');
            resultArea.innerHTML = '<div class="flex flex-col items-center justify-center py-8 gap-3"><div class="loading-spinner"></div><p class="text-xs text-slate-400">AIが思考中...</p></div>';

            if (!activeKey) {
                resultArea.innerHTML = '<div class="p-4 bg-orange-50 text-orange-700 rounded-xl border border-orange-200 text-sm">APIキーが設定されていません。右上の歯車アイコンから設定してください。</div>';
                return;
            }

            const prompt = `以下のニュースを日本語で簡潔に（最大3項目、箇条書きで）要約してください：\n\nタイトル: ${title}\n内容: ${desc.substring(0, 500)}`;

            try {
                // 指数バックオフ付きのリトライ実装（簡易版）
                let response;
                let retries = 0;
                while(retries < 3) {
                    response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${activeKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    if (response.ok) break;
                    retries++;
                    await new Promise(r => setTimeout(r, 1000 * retries));
                }

                if (!response.ok) {
                    const errorJson = await response.json();
                    throw new Error(errorJson.error?.message || "API通信エラー");
                }

                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                resultArea.innerHTML = `<div class="prose prose-slate prose-sm"><p class="whitespace-pre-wrap">${text || '要約に失敗しました。'}</p></div>`;

            } catch (err) {
                resultArea.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-2xl">
                        <p class="text-red-600 font-bold text-sm">要約に失敗しました</p>
                        <p class="text-[11px] text-red-400 mt-1">${err.message}</p>
                    </div>`;
            }
        }

        function closeModal() { document.getElementById('aiModal').classList.add('hidden'); }

        async function addFeed() {
            const urlInput = document.getElementById('rssUrl');
            const url = urlInput.value.trim();
            if (url && !feeds.includes(url)) {
                feeds.push(url);
                localStorage.setItem('rss_feeds', JSON.stringify(feeds));
                urlInput.value = "";
                await refreshAll();
            }
        }

        async function refreshAll() {
            const container = document.getElementById('articles');
            container.innerHTML = '<div class="col-span-full py-20 text-center animate-pulse text-slate-400 font-bold">フィードを更新中...</div>';
            
            let allItems = [];
            for (const url of feeds) {
                try {
                    const res = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`);
                    const data = await res.json();
                    if (data.status === 'ok') {
                        allItems = [...allItems, ...data.items.map(i => ({ ...i, siteName: data.feed.title }))];
                    }
                } catch (e) { console.error("Feed error:", e); }
            }
            
            allItems.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
            renderArticles(allItems);
            renderSubs();
        }

        function renderSubs() {
            document.getElementById('subscriptionList').innerHTML = feeds.map(url => `
                <div class="group flex items-center justify-between bg-white px-4 py-2 rounded-xl border border-slate-200 hover:border-orange-200 transition-colors">
                    <span class="text-[10px] text-slate-500 truncate mr-2">${url}</span>
                    <button onclick="removeFeed('${url}')" class="text-slate-300 hover:text-red-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                    </button>
                </div>`).join('');
        }

        function removeFeed(url) {
            feeds = feeds.filter(f => f !== url);
            localStorage.setItem('rss_feeds', JSON.stringify(feeds));
            refreshAll();
        }

        function renderArticles(items) {
            const container = document.getElementById('articles');
            if (items.length === 0) {
                container.innerHTML = '<div class="col-span-full text-center py-20 text-slate-400">記事がありません。</div>';
                return;
            }
            
            container.innerHTML = items.slice(0, 24).map(item => {
                // HTMLタグの除去とクォートのエスケープ
                const cleanDesc = item.description.replace(/<[^>]*>?/gm, '').replace(/"/g, '&quot;');
                const cleanTitle = item.title.replace(/"/g, '&quot;');
                
                return `
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm flex flex-col hover:shadow-md transition-all group">
                    <div class="flex justify-between items-start mb-2">
                        <span class="px-2 py-0.5 bg-orange-50 text-orange-600 text-[10px] font-bold rounded-md uppercase tracking-wider">${item.siteName || 'News'}</span>
                        <span class="text-[10px] text-slate-300">${new Date(item.pubDate).toLocaleDateString()}</span>
                    </div>
                    <h3 class="font-bold text-slate-800 mb-4 line-clamp-2 leading-snug group-hover:text-orange-600 transition-colors">${item.title}</h3>
                    <div class="mt-auto flex justify-between items-center pt-4 border-t border-slate-50">
                        <a href="${item.link}" target="_blank" class="text-xs font-bold text-slate-400 hover:text-slate-900 transition-colors flex items-center gap-1">
                            記事を読む
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                        </a>
                        <button 
                            data-title="${cleanTitle}" 
                            data-desc="${cleanDesc}"
                            onclick="handleSummarize(this)" 
                            class="bg-slate-900 text-white px-4 py-2 rounded-xl font-bold text-[11px] hover:bg-orange-500 transition-all shadow-sm">
                            ✨ 要約
                        </button>
                    </div>
                </div>`;
            }).join('');
        }

        window.onload = refreshAll;
    </script>
</body>
</html>